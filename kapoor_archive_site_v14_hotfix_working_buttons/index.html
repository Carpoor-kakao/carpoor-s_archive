<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ì¹´í‘¸ì–´'s ì•„ì¹´ì´ë¸Œ</title>
<style>
  :root{--bg:#0a0b12;--text:#e9eef7;--muted:#9aa3b2;--line:rgba(255,255,255,.12);--accent:#6aa1ff;}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#0a0b12cc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px)}
  .container{max-width:1100px;margin:0 auto;padding:14px 16px}
  .row{display:flex;gap:14px;align-items:center}
  .logo{width:160px;height:160px;display:flex;align-items:center;justify-content:center}
  .logo img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 0 2px rgba(255,255,255,.3))}
  h1{margin:0;font-size:28px;font-weight:800} .sub{color:var(--muted);font-size:13px;margin-top:4px}
  .btn{border:1px solid var(--line);background:#121527;color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#171b31} .badge{border:1px solid var(--line);border-radius:999px;padding:4px 8px;color:var(--muted);font-size:12px}
  .hero{padding:40px 16px} .panel{border:1px solid var(--line);border-radius:16px;background:#0f1324;padding:18px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:14px}
  .cat{display:flex;gap:10px;align-items:center;border:1px solid var(--line);background:#12162b;padding:14px;border-radius:14px;cursor:pointer}
  .cat:hover{background:#171c34;transform:translateY(-1px)} .emoji{font-size:18px;width:28px;text-align:center}
  main{display:none} .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .pill{border:1px solid var(--line);background:#12162b;border-radius:999px;padding:8px 12px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px} th{color:var(--muted);font-size:12px;text-align:left;padding:0 10px}
  td{background:#11162d;border:1px solid var(--line);padding:12px 10px} tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .name{display:inline-flex;align-items:center;gap:8px} .avatar{width:26px;height:26px;border-radius:7px;object-fit:cover;border:1px solid var(--line);background:#0a0b12}
  .muted{color:var(--muted)} .hidden{display:none !important}
  /* overlay */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:50}
  .overlay.show{display:flex} .modal{width:min(700px,92vw);background:#1a2038;border:1px solid var(--line);border-radius:14px}
  .modal-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  .modal-b{padding:14px}
  /* members grid */
  .mgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  .mcard{display:flex;align-items:center;gap:10px;background:#12162b;border:1px solid var(--line);border-radius:12px;padding:10px}
  /* admin modal basic */
  dialog{border:1px solid var(--line);border-radius:14px;background:#0f1324;color:var(--text);padding:0}
  dialog .head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);padding:12px 14px}
  dialog .body{padding:14px}
  input,select,textarea{background:#0c1130;color:var(--text);border:1px solid var(--line);border-radius:8px;padding:8px 10px}
  .table-sm{width:100%;border-collapse:collapse} .table-sm th,.table-sm td{border:1px solid var(--line);padding:6px 8px;font-size:13px}
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="row" style="align-items:flex-start">
      <div class="logo"><img src="./logo.png" alt="logo"></div>
      <div style="flex:1 1 auto">
        <h1>ì¹´í‘¸ì–´'s ì•„ì¹´ì´ë¸Œ</h1>
        <div class="sub">ì¹´í‘¸ì–´ì˜ ë°ì´í„° ì°½ê³ </div>
        <div class="row" style="margin-top:8px;flex-wrap:wrap">
          <button class="btn" id="btnCopy">ë§í¬ ë³µì‚¬</button>
          <button class="btn" id="btnUpdates">ì—…ë°ì´íŠ¸</button>
          <button class="btn" id="btnAdmin">ì°½ê³ ì •ë¦¬</button>
          <span id="badgeAdmin" class="badge hidden">ê´€ë¦¬ì ëª¨ë“œ</span>
          <button class="btn hidden" id="btnHome">í™ˆìœ¼ë¡œ</button>
        </div>
      </div>
    </div>
  </div>
</header>

<section class="hero" id="hero">
  <div class="container">
    <div class="panel">
      <div style="font-size:20px;font-weight:800">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      <div class="sub">ì›í•˜ëŠ” í•­ëª©ì„ ë¨¼ì € ê³ ë¥´ì„¸ìš”. ë²„íŠ¼ì€ ë‚˜ì¤‘ì— ë” ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.</div>
      <div class="grid" id="heroGrid"></div>
    </div>
  </div>
</section>

<main id="page">
  <div class="container">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700" id="catTitle">í•­ëª©</div>
        <div class="controls">
          <label class="pill">í•­ëª© <select id="selCat"></select></label>
          <label class="pill" id="wrapSort">ì •ë ¬ <select id="selSort"><option value="desc">ê°’ í° ìˆœ</option><option value="asc">ê°’ ì‘ì€ ìˆœ</option></select></label>
        </div>
      </div>
      <div id="wrapMembers" class="hidden"></div>
      <table id="tbl">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="row" style="justify-content:space-between">
        <div style="font-weight:700">ìš”ì²­ ëª©ë¡</div>
        <button class="btn" id="btnReqOpen">ì‹ ê·œ ìš”ì²­</button>
      </div>
      <div id="reqList"></div>
    </div>
  </div>
</main>

<!-- Request -->
<dialog id="dlgReq">
  <div class="head"><strong>ì‹ ê·œ ìš”ì²­</strong><button class="btn" id="dlgReqClose">ë‹«ê¸°</button></div>
  <div class="body">
    <textarea id="reqText" rows="6" style="width:100%" placeholder="ìš”ì²­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
    <div style="margin-top:10px"><button class="btn" id="reqSave">ë“±ë¡</button></div>
  </div>
</dialog>

<!-- Updates -->
<dialog id="dlgUpd">
  <div class="head"><strong>ìµœê·¼ ì—…ë°ì´íŠ¸</strong><button class="btn" id="dlgUpdClose">ë‹«ê¸°</button></div>
  <div class="body"><div id="updList"></div></div>
</dialog>

<!-- Admin login -->
<dialog id="dlgAdminPw">
  <div class="head"><strong>ì°½ê³ ì •ë¦¬ (ê´€ë¦¬ì)</strong><button class="btn" id="dlgAdminPwClose">ë‹«ê¸°</button></div>
  <div class="body">
    <input type="password" id="adminPw" placeholder="íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥">
    <button class="btn" id="adminPwOk">í™•ì¸</button>
    <div class="sub" style="margin-top:6px">ê´€ë¦¬ì ì „ìš©ì…ë‹ˆë‹¤.</div>
  </div>
</dialog>

<!-- Admin panel -->
<dialog id="dlgAdmin">
  <div class="head"><strong>ì°½ê³ ì •ë¦¬ â€” ê´€ë¦¬ì ëª¨ë“œ</strong><div class="row"><button class="btn" id="adminLogout">ê´€ë¦¬ì í•´ì œ</button><button class="btn" id="dlgAdminClose">ë‹«ê¸°</button></div></div>
  <div class="body">
    <div style="font-weight:700;margin-bottom:6px">ì‚¬ëŒ ê´€ë¦¬</div>
    <div class="row" style="gap:6px;margin-bottom:8px">
      <input id="newPerson" placeholder="ìƒˆ ì´ë¦„">
      <button class="btn" id="addPerson">ì¶”ê°€</button>
    </div>
    <table class="table-sm">
      <thead><tr><th style="width:40px">ì‚¬ì§„</th><th>ì´ë¦„</th><th style="width:210px">ì‚¬ì§„ ì—…ë¡œë“œ</th><th style="width:100px">ì‚¬ì§„ ì œê±°</th><th style="width:100px">ì‚­ì œ</th></tr></thead>
      <tbody id="peopleTable"></tbody>
    </table>

    <div style="font-weight:700;margin:14px 0 6px">ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</div>
    <div class="row" style="gap:6px;margin-bottom:8px">
      <input id="catId" placeholder="id (ì˜ˆ:bmi)">
      <input id="catName" placeholder="ì´ë¦„ (ì˜ˆ:BMI)">
      <select id="catType"><option value="metric">metric</option><option value="profile">profile</option><option value="members">members</option></select>
      <input id="catUnit" placeholder="ë‹¨ìœ„(ì„ íƒ)">
      <input id="catEmoji" placeholder="ì•„ì´ì½˜(ì„ íƒ, ì˜ˆ:ğŸ“Š)">
      <button class="btn" id="addCat">ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
    </div>
    <table class="table-sm">
      <thead><tr><th>id</th><th>ì´ë¦„</th><th>ìœ í˜•</th><th>ë‹¨ìœ„</th><th>ì•„ì´ì½˜</th><th style="width:100px">ì‚­ì œ</th></tr></thead>
      <tbody id="catsTable"></tbody>
    </table>

    <div style="font-weight:700;margin:14px 0 6px">ë°ì´í„° í¸ì§‘</div>
    <div class="row" style="gap:6px;margin-bottom:8px">
      <select id="editCat"></select>
      <button class="btn" id="editRefresh">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div id="editArea"></div>

    <div style="font-weight:700;margin:14px 0 6px">ë°±ì—…/ë³µêµ¬</div>
    <div class="row" style="gap:6px;margin-bottom:8px">
      <button class="btn" id="btnExport">ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn" id="btnImport">ê°€ì ¸ì˜¤ê¸°</button>
    </div>
    <textarea id="jsonArea" rows="8" style="width:100%"></textarea>
  </div>
</dialog>

<!-- Profile overlay -->
<div class="overlay" id="ov">
  <div class="modal">
    <div class="modal-h"><div class="row"><img id="ovAvatar" class="avatar"><strong id="ovName"></strong></div><button class="btn" id="ovClose">ë‹«ê¸°</button></div>
    <div class="modal-b"><div id="ovBody" class="muted"></div></div>
  </div>
</div>

<script>
(function(){
  // --- basic error banner to catch issues ---
  window.onerror = function(msg, src, line, col, err){
    try{
      var b=document.createElement('div'); b.style.cssText='position:fixed;left:10px;bottom:10px;background:#3a0c0c;color:#fff;border:1px solid #ea6; padding:8px 10px;border-radius:8px;z-index:9999';
      b.textContent='ì˜¤ë¥˜: '+msg; document.body.appendChild(b);
    }catch(e){}
  };

  // --- Data ---
  var DEFAULT = {
    people:["ë¯¼ìˆ˜","ì§€ì—°","ìˆ˜í˜„","íƒœí˜¸","ë£¨ì¹´"],
    categories:[
      {id:"weight",name:"ëª¸ë¬´ê²Œ",unit:"kg",emoji:"âš–ï¸",type:"metric",scores:{},updated:{}},
      {id:"height",name:"í‚¤",unit:"cm",emoji:"ğŸ“",type:"metric",scores:{},updated:{}},
      {id:"profile",name:"í”„ë¡œí•„",emoji:"ğŸ‘¤",type:"profile"},
      {id:"members",name:"ë©¤ë²„ ëª…ë‹¨ ë³´ê¸°",emoji:"ğŸ§‘â€ğŸ¤â€ğŸ§‘",type:"members"}
    ],
    profiles:{},
    avatars:{}
  };
  var STORAGE="ARCHIVE_DATA_V11", ADMIN="5193", PINNED=["weight","height","profile","members"];
  var DATA = JSON.parse(JSON.stringify(DEFAULT));
  try{
    var raw = localStorage.getItem(STORAGE);
    if(raw){ var saved = JSON.parse(raw);
      // merge people
      if(saved && saved.people && saved.people.length){ var set={}; DATA.people.concat(saved.people).forEach(function(n){ if(n) set[n]=1; }); DATA.people=Object.keys(set); }
      // merge categories by id
      if(saved && saved.categories && saved.categories.length){
        var byId={}; DATA.categories.forEach(function(c){byId[c.id]=c;});
        saved.categories.forEach(function(c){ if(c && c.id){ byId[c.id]=Object.assign({scores:{},updated:{}}, byId[c.id]||{}, c); }});
        DATA.categories = Object.keys(byId).map(function(k){return byId[k];});
      }
      if(saved && saved.profiles) DATA.profiles = saved.profiles;
      if(saved && saved.avatars) DATA.avatars = saved.avatars;
    }
  }catch(e){}

  // --- helpers ---
  function $(id){ return document.getElementById(id); }
  function copy(t){ if(navigator.clipboard){ navigator.clipboard.writeText(t).then(function(){ toast('ë³µì‚¬ë¨'); }); } }
  function toast(m){ var el=document.createElement('div'); el.textContent=m; el.style.cssText='position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#141a33;color:#fff;border:1px solid rgba(255,255,255,.2);padding:8px 10px;border-radius:8px;z-index:9999'; document.body.appendChild(el); setTimeout(function(){ document.body.removeChild(el); }, 1200); }
  function avatar(name){ return (DATA.avatars && DATA.avatars[name]) ? DATA.avatars[name] : ""; }
  function getCat(id){ for(var i=0;i<DATA.categories.length;i++){ if(DATA.categories[i].id===id) return DATA.categories[i]; } return null; }
  function setURLCat(id){ var u=new URL(location.href); u.searchParams.set('cat', id); history.replaceState({},'',u); }
  function getURLCat(){ var u=new URL(location.href); return u.searchParams.get('cat'); }

  // --- Hero buttons ---
  function renderHero(){
    var order = PINNED.slice();
    DATA.categories.forEach(function(c){ if(order.indexOf(c.id)===-1) order.push(c.id); });
    var html = "";
    order.forEach(function(id){
      var c = getCat(id); if(!c) return;
      html += '<div class="cat" data-id="'+c.id+'"><div class="emoji">'+(c.emoji||"ğŸ·ï¸")+'</div><div><div style="font-weight:700">'+c.name+(c.unit?(" ("+c.unit+")"):"")+'</div><div class="muted" style="font-size:12px">ë°ì´í„° ë³´ê¸°</div></div></div>';
    });
    $('heroGrid').innerHTML = html;
    Array.prototype.forEach.call(document.querySelectorAll('.cat[data-id]'), function(el){
      el.addEventListener('click', function(){ openCat(el.getAttribute('data-id')); });
    });
  }

  // --- List rendering ---
  function showHero(){ $('hero').style.display='block'; $('page').style.display='none'; $('btnHome').classList.add('hidden'); }
  function showPage(){ $('hero').style.display='none'; $('page').style.display='block'; $('btnHome').classList.remove('hidden'); }

  function renderList(){
    var catId = getURLCat() || (DATA.categories[0] ? DATA.categories[0].id : 'profile');
    var cat = getCat(catId);
    $('catTitle').textContent = (cat ? cat.name : 'í•­ëª©') + (cat && cat.unit ? (' ('+cat.unit+')') : '');
    // category selector
    $('selCat').innerHTML = DATA.categories.map(function(c){ return '<option value="'+c.id+'">'+c.name+(c.unit?(' ('+c.unit+')'):'')+' â€” '+c.type+'</option>'; }).join('');
    $('selCat').value = cat ? cat.id : '';
    // reset areas
    $('wrapMembers').classList.add('hidden');
    $('tbl').style.display='table';
    // profile
    if(cat && cat.type==='profile'){
      $('wrapSort').style.display='none';
      $('thead').innerHTML = '<tr><th>ì´ë¦„</th></tr>';
      var names = {}; DATA.people.forEach(function(n){names[n]=1;}); for(var n in DATA.profiles){names[n]=1;}
      var list = Object.keys(names).sort();
      $('tbody').innerHTML = list.map(function(name){
        var av = avatar(name);
        return '<tr><td><button class="name btnLink" data-open="'+name+'" style="all:unset;cursor:pointer"><span>'+(av?'<img class="avatar" src="'+av+'">':'')+'</span><span>'+name+'</span></button></td></tr>';
      }).join('');
      Array.prototype.forEach.call(document.querySelectorAll('[data-open]'), function(b){
        b.addEventListener('click', function(){ openProfile(b.getAttribute('data-open')); });
      });
    }
    // members
    else if(cat && cat.type==='members'){
      $('wrapSort').style.display='none';
      $('tbl').style.display='none';
      $('wrapMembers').classList.remove('hidden');
      // registered members
      var set={}, i, c;
      for(i=0;i<DATA.categories.length;i++){ c=DATA.categories[i]; if(c.type==='metric'){ for(var k in (c.scores||{})){ if(c.scores[k]!=null && c.scores[k] !== '') set[k]=1; } for(var k2 in (c.updated||{})){ if(c.updated[k2]) set[k2]=1; } } }
      for(var p in DATA.profiles){ if(DATA.profiles[p] && (DATA.profiles[p].subtitle||DATA.profiles[p].bio||DATA.profiles[p].updated)) set[p]=1; }
      for(var a in DATA.avatars){ if(DATA.avatars[a]) set[a]=1; }
      var names = Object.keys(set).sort();
      $('wrapMembers').innerHTML = '<div class="mgrid">'+names.map(function(n){
        var av = avatar(n);
        return '<div class="mcard">'+(av?'<img class="avatar" style="width:40px;height:40px;border-radius:12px" src="'+av+'">':'')+'<div>'+n+'</div></div>';
      }).join('')+'</div>';
    }
    // metric
    else{
      $('wrapSort').style.display='';
      $('thead').innerHTML = '<tr><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ê°’</th><th>ì—…ë°ì´íŠ¸</th></tr>';
      var rows = DATA.people.map(function(name){
        var v = (cat && cat.scores) ? cat.scores[name] : null;
        return {name:name,value:(v!=null?Number(v):null),updated:(cat && cat.updated ? cat.updated[name] : '')};
      });
      var dir = $('selSort').value;
      rows.sort(function(a,b){
        var av = (a.value==null?-1e15:a.value), bv=(b.value==null?-1e15:b.value);
        var d = dir==='asc' ? (av-bv) : (bv-av);
        if(d!==0) return d; return a.name.localeCompare(b.name);
      });
      $('tbody').innerHTML = rows.map(function(r,i){
        var medal = (i===0?'<span style="background:#ffd166;color:#3a2b00;padding:3px 6px;border-radius:8px;font-weight:800">1</span>':i===1?'<span style="background:#e6eef7;color:#263246;padding:3px 6px;border-radius:8px;font-weight:800">2</span>':i===2?'<span style="background:#e6b089;color:#3a2312;padding:3px 6px;border-radius:8px;font-weight:800">3</span>':'<span class="muted">'+(i+1)+'</span>');
        var v = (r.value==null?'-':(Math.round(r.value*100)/100));
        var av = avatar(r.name);
        return '<tr><td>'+medal+'</td><td><span class="name">'+(av?'<img class="avatar" src="'+av+'">':'')+'<span>'+r.name+'</span></span></td><td>'+v+'</td><td class="muted">'+(r.updated||'-')+'</td></tr>';
      }).join('');
    }
  }

  function openCat(id){ setURLCat(id); showPage(); renderList(); }

  // profile overlay
  function openProfile(name){
    var p = (DATA.profiles && DATA.profiles[name]) ? DATA.profiles[name] : {};
    $('ovName').textContent = name;
    var av = avatar(name); if(av){ $('ovAvatar').src=av; $('ovAvatar').style.visibility='visible'; } else { $('ovAvatar').removeAttribute('src'); $('ovAvatar').style.visibility='hidden'; }
    $('ovBody').innerHTML = (p.subtitle?('<div style="font-weight:700;margin-bottom:6px">'+p.subtitle+'</div>'):'') + (p.bio?('<div style="white-space:pre-wrap">'+p.bio+'</div>'):'<div class="muted">í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.</div>') + (p.updated?('<div class="muted" style="margin-top:8px;font-size:12px">ì—…ë°ì´íŠ¸: '+p.updated+'</div>') : '');
    $('ov').classList.add('show');
  }
  $('ovClose').addEventListener('click', function(){ $('ov').classList.remove('show'); });
  $('ov').addEventListener('click', function(e){ if(e.target.id==='ov') $('ov').classList.remove('show'); });

  // updates
  function parseDate(s){ if(!s) return null; var t=Date.parse(s); if(!isNaN(t)) return new Date(t); s=s.replace(/[./]/g,'-'); t=Date.parse(s); return isNaN(t)?null:new Date(t); }
  function collectUpdates(){
    var items=[];
    DATA.categories.forEach(function(cat){
      if(cat.type==='metric'){
        for(var n in (cat.updated||{})){ var d=parseDate(cat.updated[n]); if(d){ items.push({date:d,label:'['+cat.name+'] '+n,detail:(cat.scores&&cat.scores[n]!=null?cat.scores[n]+(cat.unit||''):'ê°’ ë¯¸ì…ë ¥')}); } }
      }
    });
    for(var n in (DATA.profiles||{})){
      var p=DATA.profiles[n]; var d=parseDate(p.updated); if(d){ items.push({date:d,label:'[í”„ë¡œí•„] '+n,detail:(p.subtitle||p.bio||'í”„ë¡œí•„ ì—…ë°ì´íŠ¸')}); }
    }
    items.sort(function(a,b){ return b.date - a.date; });
    return items;
  }

  // admin area
  function isAdmin(){ return sessionStorage.getItem('admin')==='1'; }
  function setAdmin(v){ if(v){ sessionStorage.setItem('admin','1'); $('badgeAdmin').classList.remove('hidden'); } else { sessionStorage.removeItem('admin'); $('badgeAdmin').classList.add('hidden'); } }
  function save(){ try{ localStorage.setItem(STORAGE, JSON.stringify(DATA)); }catch(e){} }

  function fillPeople(){
    // registered members only
    var set={}, i,c;
    for(i=0;i<DATA.categories.length;i++){ c=DATA.categories[i]; if(c.type==='metric'){ for(var k in (c.scores||{})){ if(c.scores[k]!=null && c.scores[k]!=='') set[k]=1; } for(var k2 in (c.updated||{})){ if(c.updated[k2]) set[k2]=1; } } }
    for(var p in DATA.profiles){ if(DATA.profiles[p] && (DATA.profiles[p].subtitle||DATA.profiles[p].bio||DATA.profiles[p].updated)) set[p]=1; }
    for(var a in DATA.avatars){ if(DATA.avatars[a]) set[a]=1; }
    var list = Object.keys(set).sort();
    $('peopleTable').innerHTML = list.map(function(n){
      var av = avatar(n);
      return '<tr><td>'+(av?'<img class="avatar" src="'+av+'">':'')+'</td><td>'+n+'</td><td><input type="file" accept="image/*" data-up="'+n+'"></td><td><button class="btn" data-clr="'+n+'">ì œê±°</button></td><td><button class="btn" data-del="'+n+'">ì‚­ì œ</button></td></tr>';
    }).join('');
    Array.prototype.forEach.call(document.querySelectorAll('input[type="file"][data-up]'), function(inp){
      inp.addEventListener('change', function(e){
        var f = inp.files && inp.files[0]; if(!f) return;
        var r = new FileReader(); r.onload = function(){ if(!DATA.avatars) DATA.avatars={}; DATA.avatars[inp.getAttribute('data-up')] = r.result; save(); fillPeople(); renderList(); };
        r.readAsDataURL(f);
      });
    });
    Array.prototype.forEach.call(document.querySelectorAll('button[data-clr]'), function(b){
      b.addEventListener('click', function(){ if(DATA.avatars){ delete DATA.avatars[b.getAttribute('data-clr')]; save(); fillPeople(); renderList(); } });
    });
    Array.prototype.forEach.call(document.querySelectorAll('button[data-del]'), function(b){
      b.addEventListener('click', function(){
        var name=b.getAttribute('data-del'); if(!confirm(name+' ì‚­ì œ?')) return;
        DATA.people = DATA.people.filter(function(x){return x!==name;});
        DATA.categories.forEach(function(cat){ if(cat.type==='metric'){ if(cat.scores) delete cat.scores[name]; if(cat.updated) delete cat.updated[name]; } });
        if(DATA.profiles) delete DATA.profiles[name];
        if(DATA.avatars) delete DATA.avatars[name];
        save(); fillPeople(); renderList();
      });
    });
  }
  function fillCats(){
    $('catsTable').innerHTML = DATA.categories.map(function(c){
      return '<tr><td>'+c.id+'</td><td>'+c.name+'</td><td>'+c.type+'</td><td>'+(c.unit||'')+'</td><td>'+(c.emoji||'')+'</td><td><button class="btn" data-rmcat="'+c.id+'">ì‚­ì œ</button></td></tr>';
    }).join('');
    Array.prototype.forEach.call(document.querySelectorAll('[data-rmcat]'), function(b){
      b.addEventListener('click', function(){
        var id=b.getAttribute('data-rmcat'); if(!confirm(id+' ì¹´í…Œê³ ë¦¬ ì‚­ì œ?')) return;
        DATA.categories = DATA.categories.filter(function(x){ return x.id!==id; });
        save(); fillCats(); renderHero(); renderList();
      });
    });
    // editor select
    $('editCat').innerHTML = DATA.categories.map(function(c){ return '<option value="'+c.id+'">'+c.name+(c.unit?(' ('+c.unit+')'):'')+' â€” '+c.type+'</option>'; }).join('');
    if(!getCat($('editCat').value) && DATA.categories[0]) $('editCat').value = DATA.categories[0].id;
    fillEditor($('editCat').value);
  }
  function fillEditor(catId){
    var c = getCat(catId); if(!c){ $('editArea').innerHTML='<div class="muted">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒ</div>'; return; }
    // profile
    if(c.type==='profile'){
      var rows = DATA.people.map(function(name){
        var p = (DATA.profiles && DATA.profiles[name]) ? DATA.profiles[name] : {};
        return '<tr><td>'+name+'</td><td><input data-n="'+name+'" data-k="subtitle" value="'+(p.subtitle?String(p.subtitle).replace(/"/g,'&quot;'):'')+'"></td><td><input data-n="'+name+'" data-k="bio" value="'+(p.bio?String(p.bio).replace(/"/g,'&quot;'):'')+'"></td><td><input data-n="'+name+'" data-k="updated" placeholder="YYYY-MM-DD" value="'+(p.updated||'')+'"></td></tr>';
      }).join('');
      $('editArea').innerHTML = '<table class="table-sm"><thead><tr><th>ì´ë¦„</th><th>ë¶€ì œ</th><th>ë°”ì´ì˜¤</th><th>ì—…ë°ì´íŠ¸</th></tr></thead><tbody>'+rows+'</tbody></table><div style="margin-top:8px"><button class="btn" id="saveProfile">ì €ì¥</button></div>';
      $('saveProfile').onclick=function(){
        DATA.people.forEach(function(name){
          var q=function(k){ return document.querySelector('input[data-n="'+name+'"][data-k="'+k+'"]'); };
          var sub=q('subtitle').value.trim(), bio=q('bio').value.trim(), upd=q('updated').value.trim();
          if(!DATA.profiles) DATA.profiles={}; if(!DATA.profiles[name]) DATA.profiles[name]={};
          if(sub||bio||upd){ DATA.profiles[name].subtitle=sub||undefined; DATA.profiles[name].bio=bio||undefined; DATA.profiles[name].updated=upd||undefined; }
          if(!sub && !bio && !upd){ delete DATA.profiles[name]; }
        });
        save(); renderList(); toast('ì €ì¥ë¨');
      };
    } else if(c.type==='members'){
      $('editArea').innerHTML = '<div class="muted">ë©¤ë²„ ëª…ë‹¨ì€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div>';
    } else { // metric
      var rows = DATA.people.map(function(name){
        var v = c.scores? (c.scores[name]!=null?c.scores[name]:'') : '';
        var u = c.updated? (c.updated[name]||'') : '';
        return '<tr><td>'+name+'</td><td><input data-n="'+name+'" data-k="value" value="'+v+'"></td><td><input data-n="'+name+'" data-k="updated" placeholder="YYYY-MM-DD" value="'+u+'"></td></tr>';
      }).join('');
      $('editArea').innerHTML = '<table class="table-sm"><thead><tr><th>ì´ë¦„</th><th>ê°’'+(c.unit?(' ('+c.unit+')'):'')+'</th><th>ì—…ë°ì´íŠ¸</th></tr></thead><tbody>'+rows+'</tbody></table><div style="margin-top:8px"><button class="btn" id="saveMetric">ì €ì¥</button></div>';
      $('saveMetric').onclick=function(){
        if(!c.scores) c.scores={}; if(!c.updated) c.updated={};
        DATA.people.forEach(function(name){
          var q=function(k){ return document.querySelector('input[data-n="'+name+'"][data-k="'+k+'"]'); };
          var v=q('value').value.trim(); var u=q('updated').value.trim();
          c.scores[name] = (v===''? null : Number(v));
          c.updated[name] = u || '';
        });
        save(); renderList(); toast('ì €ì¥ë¨');
      };
    }
  }

  // --- events ---
  $('selCat').addEventListener('change', function(){ openCat(this.value); });
  $('selSort').addEventListener('change', renderList);
  $('btnHome').addEventListener('click', function(){ var u=new URL(location.href); u.searchParams.delete('cat'); history.replaceState({},'',u); showHero(); });
  $('btnCopy').addEventListener('click', function(){ copy(location.href); });
  $('btnUpdates').addEventListener('click', function(){
    var items = collectUpdates();
    $('updList').innerHTML = items.length? items.map(function(it){ return '<div style="border:1px solid var(--line);background:#12162b;border-radius:10px;padding:8px 10px;margin-bottom:8px"><div><strong>'+it.label+'</strong></div><div class="muted" style="font-size:12px">'+it.date.toISOString().slice(0,10)+'</div><div>'+it.detail+'</div></div>'; }).join('') : '<div class="muted">ìµœê·¼ ì—…ë°ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    $('dlgUpd').showModal();
  });
  $('dlgUpdClose').addEventListener('click', function(){ $('dlgUpd').close(); });

  $('btnReqOpen').addEventListener('click', function(){ $('reqText').value=''; $('dlgReq').showModal(); });
  $('dlgReqClose').addEventListener('click', function(){ $('dlgReq').close(); });
  var REQ="req_list"; var reqs = []; try{ reqs = JSON.parse(localStorage.getItem(REQ) || "[]"); }catch(e){}
  function renderReqs(){ $('reqList').innerHTML = reqs.map(function(r){ return '<div style="border:1px solid var(--line);background:#12162b;border-radius:10px;padding:8px 10px;margin-bottom:8px">'+r.text+'<div class="muted" style="font-size:12px">'+r.date+'</div></div>'; }).join(''); }
  renderReqs();
  $('reqSave').addEventListener('click', function(){ var v=$('reqText').value.trim(); if(!v) return; reqs.unshift({text:v,date:new Date().toLocaleString()}); localStorage.setItem(REQ, JSON.stringify(reqs)); $('dlgReq').close(); renderReqs(); });

  // admin
  $('btnAdmin').addEventListener('click', function(){ if(!isAdmin()){ $('adminPw').value=''; $('dlgAdminPw').showModal(); } else { fillPeople(); fillCats(); $('dlgAdmin').showModal(); } });
  $('dlgAdminPwClose').addEventListener('click', function(){ $('dlgAdminPw').close(); });
  $('adminPwOk').addEventListener('click', function(){ if($('adminPw').value===ADMIN){ setAdmin(true); $('dlgAdminPw').close(); fillPeople(); fillCats(); $('dlgAdmin').showModal(); } else { toast('íŒ¨ìŠ¤ì›Œë“œ ì˜¤ë¥˜'); } });
  $('dlgAdminClose').addEventListener('click', function(){ $('dlgAdmin').close(); });
  $('adminLogout').addEventListener('click', function(){ setAdmin(false); $('dlgAdmin').close(); });

  $('addPerson').addEventListener('click', function(){ var name=$('newPerson').value.trim(); if(!name) return; if(DATA.people.indexOf(name)===-1) DATA.people.push(name); $('newPerson').value=''; save(); fillPeople(); renderList(); });
  $('addCat').addEventListener('click', function(){
    var id=$('catId').value.trim(), name=$('catName').value.trim(), type=$('catType').value, unit=$('catUnit').value.trim(), emoji=$('catEmoji').value.trim();
    if(!id||!name) return toast('id/ì´ë¦„ ì…ë ¥');
    if(getCat(id)) return toast('ì´ë¯¸ ì¡´ì¬');
    var cat={id:id,name:name,type:type,emoji:emoji};
    if(type==='metric'){ cat.unit=unit; cat.scores={}; cat.updated={}; }
    DATA.categories.push(cat); $('catId').value='';$('catName').value='';$('catUnit').value='';$('catEmoji').value='';
    save(); fillCats(); renderHero(); renderList(); toast('ì¶”ê°€ë¨');
  });
  $('editCat').addEventListener('change', function(){ fillEditor(this.value); });
  $('editRefresh').addEventListener('click', function(){ fillEditor($('editCat').value); });

  // init
  if(sessionStorage.getItem('admin')==='1') $('badgeAdmin').classList.remove('hidden');
  renderHero();
  var cur = getURLCat(); if(cur){ showPage(); renderList(); } else { showHero(); }

})();</script>
</body>
</html>
